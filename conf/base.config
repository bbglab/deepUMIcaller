/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    bbglab/deepUMIcaller Nextflow base config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    A 'blank slate' config file, appropriate for general use on most high performance
    compute environments. Assumes that all software is installed and available on
    the PATH. Runs in `local` mode - all jobs will be run on the logged in environment.
----------------------------------------------------------------------------------------
*/

process {

    resourceLimits = [ cpus: params.max_cpus, memory: params.max_memory, time: params.max_time ]

    cpus   = { 1 * task.attempt }
    memory = { 4.GB * task.attempt }
    time   = { 24.h  * task.attempt }

    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 3
    maxErrors     = '-1'

    // Process-specific resource requirements
    // NOTE - Please try and re-use the labels below as much as possible.
    //        These labels are used and recognised by default in DSL2 files hosted on nf-core/modules.
    //        If possible, it would be nice to keep the same label naming convention when
    //        adding in your local modules too.


// ========================================
    // PART 1: RESOURCE LABELS (Primary - Reusable Categories)
    // ========================================
    
    // Processes: ALIGN_BAM
    withLabel: 'alignment_intensive' {
        cpus = 24
        memory = 16.GB
    }

    // Processes: SAMTOOLS_SORT
    withLabel: 'bam_sort_compress' {
        cpus = 8
        memory = 14.GB
    }
    
    // Processes: QUALIMAP_BAMQC
    withLabel: 'qc_memory_intensive' {
        cpus = 2
        memory = 170.GB
    }
    
    // Processes: ASMINUSXS, FGBIO_CLIPBAM, BAMUTIL_TRIMBAM
    withLabel: 'bam_processing_heavy' {
        cpus = 4
        memory = 25.GB
    }
    
    // Processes: PILEUPBAM, MUTSPERPO
    withLabel: 'pileup_extreme' {
        cpus = 1
        memory = 2.GB
    }
    
    // Processes: PATCHDP
    withLabel: 'postprocess_memory' {
        cpus = 1
        memory = 22.GB
    }
    
    // Processes: NSXPOSITION, QUERYTABIX
    withLabel: 'postprocess_compute' {
        cpus = 1
        memory = 512.MB
    }
    
    // Processes: FGBIO_FILTERCONSENSUSREADS, SAMTOOLS_FILTER
    withLabel: 'consensus_filter' {
        cpus = 1
        memory = 20.GB
    }
    
    // Processes: FGBIO_GROUPREADSBYUMI
    withLabel: 'groupreads_io' {
        cpus = 1
        memory = 2.GB
    }
    
    // Processes: CALLING_VARDICT_CHUNK, MERGE_VARDICT_RESULTS
    withLabel: 'variant_calling' {
        cpus = 2
        memory = 15.GB
    }
    
    // Processes: FILTERNANOSEQSNP, FILTERNANOSEQNOISE, FILTERLOWCOMPLEX, 
    //            FILTERNRICH, FILTERVCFSOMATIC, FILTERVCFPLOT
    withLabel: 'variant_filtering' {
        cpus = 1
        memory = 10.GB
    }
    
    // Processes: PILEUPBAMALL
    withLabel: 'pileup_prep' {
        cpus = 1
        memory = 15.GB
    }
    
    // Processes: SAMTOOLS_DEPTH, BEDTOOLS_COVERAGE
    withLabel: 'coverage_compute' {
        cpus = 1
        memory = 512.MB
    }
    
    // Processes: FGBIO_FASTQTOBAM
    withLabel: 'fastq_processing' {
        cpus = 1
        memory = 3.GB
    }
    
    // Processes: PICARD_BEDTOINTERVALLIST, SAMPLESHEET_CHECK
    withLabel: 'genomic_prep' {
        cpus = 1
        memory = 1.GB
    }
    
    // Processes: CREATEBED_FROM_TSV, SPLIT_BED, READJUSTREGIONS_AMP, READJUSTREGIONS_NOAMP
    withLabel: 'bed_operations' {
        cpus = 1
        memory = 512.MB
    }
    
    // Processes: SIGPROFILER_MATRIXGENERATOR
    withLabel: 'signature_analysis' {
        cpus = 1
        memory = 1.GB
    }
    
    // Processes: FAMILYSIZEMETRICS
    withLabel: 'family_metrics' {
        cpus = 1
        memory = 256.MB
    }
    
    // Processes: COHORTMUTSPERPOS
    withLabel: 'cohort_analysis' {
        cpus = 1
        memory = 1.GB
    }
    
    // Processes: MULTIQC, MULTIQCDUPLEX, CUSTOM_DUMPSOFTWAREVERSIONS
    withLabel: 'reporting' {
        cpus = 1
        memory = 2.GB
    }
    
    
    // ========================================
    // PART 2: PROCESS-SPECIFIC OVERRIDES
    // ========================================

    withName: 'DEEPUMICALLER:FASTQC' {
        cpus = 2  
        memory = 3.GB 
    }
    
    withName: 'DEEPUMICALLER:POSTPROCESSMUTATIONS:PATCHDPALL' {
        memory = { 22.GB + (10.GB * (task.attempt - 1)) }
        time = { 30.m * task.attempt }
        errorStrategy = 'retry'
        maxRetries = 3
    }
    
    withName: 'DEEPUMICALLER:COVERAGETARGETED|DEEPUMICALLER:COVERAGEGLOBAL' {
        memory = { 4.GB * task.attempt }
        time = 30.m
        errorStrategy = { task.exitStatus == 137 ? 'retry' : 'terminate' }
        maxRetries = 2
    }

    withName: 'DEEPUMICALLER:QUALIMAPQCRAW|DEEPUMICALLER:QUALIMAP_BAMQC' {
        memory = 180.GB
    }
    

    withName: 'DEEPUMICALLER:DISCARDEDCOVERAGEGLOBAL|DEEPUMICALLER:DISCARDEDCOVERAGETARGETED' {
        memory = 140.GB
    }

    withName: 'DEEPUMICALLER:SPLITBAMCHROM' {
        cpus = 4            
        memory = 1.5.GB   
    }

    withName: 'DEEPUMICALLER:MERGEBAM' {
        cpus = 4
        memory = 1.5.GB
    }
    
}