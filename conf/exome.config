/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    bbglab/deepUMIcaller Nextflow exome config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for exome/targeted sequencing workflows.
    Uses custom pipeline-specific labels with resource tuning for exome-specific needs.
----------------------------------------------------------------------------------------
*/

process {

    resourceLimits = [ cpus: params.max_cpus, memory: params.max_memory, time: params.max_time ]

    cpus   = { 2 * task.attempt }
    memory = { 16.GB * task.attempt }
    time   = { 24.h * task.attempt }

    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 3
    maxErrors     = '-1'

    // ========================================
    // PART 1: RESOURCE LABELS (Primary - Reusable Categories)
    // ========================================
    
    // Processes: ALIGNRAWBAM, ALIGNDUPLEXCONSENSUSBAM
    withLabel: 'alignment_intensive' {
        cpus = { 24 * task.attempt }
        memory = { 16.GB * task.attempt }
    }

    // Processes: SORTBAM, SORTBAMCLEAN, SORTBAMALLMOLECULES, SORTBAMAMFILTERED, SORTBAMAMCLEAN, SORTBAMDUPLEXCONS
    withLabel: 'bam_sort_compress' {
        cpus = { 8 * task.attempt }
        memory = { 16.GB * task.attempt }
    }
    
    // Processes: QUALIMAPQCRAW, QUALIMAPQCALLMOLECULES, QUALIMAPQCDUPLEX
    withLabel: 'qc_memory_intensive' {
        cpus = { 2 * task.attempt }
        memory = { 170.GB * task.attempt }
    }
    
    // Processes: ASMINUSXSDUPLEX, CLIPBAM, TRIMBAM
    withLabel: 'bam_processing_heavy' {
        cpus = { 4 * task.attempt }
        memory = { 20.GB * task.attempt }
    }
    
    // Processes: SAMTOOLS_MPILEUP (PILEUPBAM, PILEUPBAMALL), MUTSPERPOS
    withLabel: 'pileup_extreme' {
        cpus = { 1 * task.attempt }
        memory = { 2.GB * task.attempt }
    }
    
    // Processes: PATCHDP
    withLabel: 'postprocess_memory' {
        cpus = { 1 * task.attempt }
        memory = { 80.GB * task.attempt }
    }
    
    // Processes: NSXPOSITION, QUERYTABIX
    withLabel: 'postprocess_compute' {
        cpus = { 1 * task.attempt }
        memory = { 512.MB * task.attempt }
    }
    
    // Processes: FILTERCONSENSUSREADSDUPLEX, FILTERCONSENSUSREADSAM, SAMTOOLSFILTERALLMOLECULES
    withLabel: 'consensus_filter' {
        cpus = { 1 * task.attempt }
        memory = { 20.GB * task.attempt }
    }
    
    // Processes: GROUPREADSBYUMIDUPLEX
    withLabel: 'groupreads_io' {
        cpus = { 1 * task.attempt }
        memory = { 2.GB * task.attempt }
    }
    
    // Processes: CALLING_VARDICT_CHUNK, MERGE_VARDICT_RESULTS
    withLabel: 'variant_calling' {
        cpus = { 2 * task.attempt }
        memory = { 60.GB * task.attempt }
    }
    
    // Processes: FILTERLOWMAPPABLE, FILTERLOWCOMPLEX, FILTERNRICH, FILTERVCFSOMATIC, FILTERVCFPLOT
    withLabel: 'variant_filtering' {
        cpus = { 1 * task.attempt }
        memory = { 25.GB * task.attempt }
    }
    
    // Processes: PILEUPBAMALL
    withLabel: 'pileup_prep' {
        cpus = { 1 * task.attempt }
        memory = { 15.GB * task.attempt }
    }
    
    // Processes: COMPUTEDEPTH
    withLabel: 'coverage_compute' {
        cpus = { 1 * task.attempt }
        memory = { 512.MB * task.attempt }
    }
    
    // Processes: FASTQTOBAM
    withLabel: 'fastq_processing' {
        cpus = { 1 * task.attempt }
        memory = { 3.GB * task.attempt }
    }
    
    // Processes: BEDTOINTERVAL, SAMPLESHEET_CHECK
    withLabel: 'genomic_prep' {
        cpus = { 1 * task.attempt }
        memory = { 1.GB * task.attempt }
    }
    
    // Processes: CREATEBED, SPLIT_BED, READJUSTREGIONS_AMP, READJUSTREGIONS_NOAMP
    withLabel: 'bed_operations' {
        cpus = { 1 * task.attempt }
        memory = { 512.MB * task.attempt }
    }
    
    // Processes: SIGPROFILER_MATRIXGENERATOR (SIGPROFPLOT, SIGPROFPLOTPUR, SIGPROFPLOTPYR)
    withLabel: 'signature_analysis' {
        cpus = { 1 * task.attempt }
        memory = { 1.GB * task.attempt }
    }
    
    // Processes: FAMILYMETRICSONTARGET, FAMILYMETRICS
    withLabel: 'family_metrics' {
        cpus = { 1 * task.attempt }
        memory = { 256.MB * task.attempt }
    }
    
    // Processes: COHORTMUTSPERPOS
    withLabel: 'cohort_analysis' {
        cpus = { 1 * task.attempt }
        memory = { 1.GB * task.attempt }
    }
    
    // Processes: MULTIQC, MULTIQCDUPLEX, CUSTOM_DUMPSOFTWAREVERSIONS
    withLabel: 'reporting' {
        cpus = { 1 * task.attempt }
        memory = { 2.GB * task.attempt }
    }
    
    // Processes: COLLECTDUPLEXSEQMETRICS, COLLECTDUPLEXSEQMETRICSONTARGET
    withLabel: 'collect_duplex_metrics' {
        cpus = { 1 * task.attempt }
        memory = { 20.GB * task.attempt }
    }

    // Processes: ENSEMBLVEP_VEP (if used)
    withLabel: 'annotation' {
        cpus = { 16 * task.attempt }
        memory = { 4.GB * task.attempt }
    }

    // Processes: CALLDUPLEXCONSENSUSREADS
    withLabel: 'consensus_calling' {
        cpus = { 1 * task.attempt }
        memory = { 5.GB * task.attempt }
    }
    
    // ========================================
    // PART 2: PROCESS-SPECIFIC OVERRIDES
    // ========================================

    withName: 'DEEPUMICALLER:FASTQC' {
        cpus = { 2 * task.attempt }
        memory = { 3.GB * task.attempt }
    }
    
    withName: 'DEEPUMICALLER:RECOUNTMUTS:PATCHDPALL' {
        cpus = { 1 * task.attempt }
        memory = { 135.GB + (10.GB * (task.attempt - 1)) }
        errorStrategy = 'retry'
        maxRetries = 3
    }
    
    withName: 'DEEPUMICALLER:COVERAGETARGETED|DEEPUMICALLER:COVERAGEGLOBAL|DEEPUMICALLER:DISCARDEDCOVERAGETARGETED|DEEPUMICALLER:DISCARDEDCOVERAGEGLOBAL' {
        cpus = { 1 * task.attempt }
        memory = { 215.GB * task.attempt }
        errorStrategy = { task.exitStatus == 137 ? 'retry' : 'terminate' }
        maxRetries = 2
    }

    withName: 'DEEPUMICALLER:QUALIMAPQCRAW|DEEPUMICALLER:QUALIMAP_BAMQC' {
        cpus = { 2 * task.attempt }
        memory = { 180.GB * task.attempt }
        errorStrategy = { task.exitStatus == 137 ? 'retry' : 'terminate' }
        maxRetries = 2
    }

    withName: 'DEEPUMICALLER:SPLITBAMCHROM' {
        cpus = { 8 * task.attempt }
        memory = { 2.5.GB * task.attempt }
    }

    withName: 'DEEPUMICALLER:MERGEBAM|DEEPUMICALLER:MERGEBAMDUPLEX' {
        cpus = { 8 * task.attempt }
        memory = { 1.5.GB * task.attempt }
    }

    withName: 'DEEPUMICALLER:FASTP' {
        cpus = { 16 * task.attempt }
        memory = { 4.GB * task.attempt }
    }

    withName: 'DEEPUMICALLER:PICARD_MERGESAMFILES' {
        cpus = { 16 * task.attempt }
        memory = { 4.GB * task.attempt }
    }
    
    withName: 'DEEPUMICALLER:ASMINUSXSDUPLEX' {
        cpus = { 4 * task.attempt }
        memory = { 120.GB * task.attempt }
    }

    withName: 'DEEPUMICALLER:RECOUNTMUTS:MUTSPERPOS' {
        cpus = { 1 * task.attempt }
        memory = { 512.MB * task.attempt }
        errorStrategy = { task.exitStatus == 140 ? 'retry' : 'finish' }
        maxRetries = 2
    }
    
    withName: 'DEEPUMICALLER:RECOUNTMUTS:PILEUPBAM' {
        cpus = { 1 * task.attempt }
        memory = { 1.GB * task.attempt }
    }
    
    withName: 'DEEPUMICALLER:BAM_CALL_VARDICT_PARALLEL:CALLING_VARDICT_CHUNK' {
        cpus = { 2 * task.attempt }
        memory = { 55.GB + (10.GB * (task.attempt - 1)) }
        errorStrategy = { task.exitStatus == 137 ? 'retry' : 'finish' }
        maxRetries = 2
    }

    withName: 'DEEPUMICALLER:CREATEBED' {
        cpus = { 1 * task.attempt }
        memory = { 512.MB * task.attempt }
    }

    withName: 'CUSTOM_DUMPSOFTWAREVERSIONS' {
        cache = false
    }
}