/*
========================================================================================
    Nextflow config file for running tests
========================================================================================
*/

includeConfig '../conf/general_files_IRB.config'

params {

    config_profile_name        = 'Test profile'
    config_profile_description = 'Test dataset to check pipeline function'

    ref_fasta               = '/data/bbg/datasets/genomes/GRCh38/clean_n_fixed_genome/GCA_000001405.15_GRCh38_no_alt_analysis_set.masked.fna'
    targetsfile             = '/data/bbg/nobackup2/scratch/fcalvet/fetch_duplex_fastqs/samplesheet/TP53_target.bed4.bed'

    trim_adapters = false
    three_prime_clip_r1 = 0
    three_prime_clip_r2 = 0
    trim_nextseq = false
    left_clip = 10
    right_clip = 30
    genome = null
    igenomes_base = 's3://ngi-igenomes/igenomes'
    igenomes_ignore = true
    multiqc_config = null
    multiqc_title = null
    max_multiqc_email_size = '25.MB'
    remove_offtargets = false
    annotate_mutations = false
    perform_qcs = true
    filter_mutations = true
    filter_regions = true
    low_complex_file = '/data/bbg/datasets/genomes/GRCh38/masking_bedfiles/hg38_lowcomplexity_repetitive_regions.mutcoords.bed'
    low_mappability_file = '/data/bbg/datasets/genomes/GRCh38/masking_bedfiles/blacklist/GRCh38.encode.blacklist.bed'
    nanoseq_snp_file = '/data/bbg/datasets/genomes/GRCh38/masking_bedfiles/nanoseq_masks/SNP_GRCh38.wgns.bed.gz'
    nanoseq_noise_file = '/data/bbg/datasets/genomes/GRCh38/masking_bedfiles/nanoseq_masks/NOISE_GRCh38.wgns.bed.gz'
    global_exons_file = '/data/bbg/datasets/prominent/metadata/regions/data/seq_panels/xgen-exome-hyb-panel-v2-targets-hg38.bed'
    asminusxs_thres = 10
    projectname = 'test_FASTQs'
    groupreadsbyumi_edits = 1
    groupreadsbyumi_min_map_q = 10
    call_min_reads_duplex = '1 1 0'
    call_min_baseq = 20
    maxN_prop_per_read = 0.2
    filter_strand_agreement = true
    filter_min_reads_am = '2 1 0'
    filter_min_baseq_am = 20
    filter_max_base_error_rate_am = '0.1 0.1 0.1'
    filter_min_reads_duplex = '4 2 2'
    filter_min_baseq_duplex = 30
    filter_max_base_error_rate_duplex = '0.1 0.1 0.1'
    vardict_params = '-f 0.0 -r 1 -m 9999 -P 0 -p -z 1 -o 0.5 -L 100'
    vardict_filter_params = '-A -E -f 0.0 -p 10 -m 20 -v 1'
    final_read_size = 270
    vep_cache = '/data/bbg/datasets/vep'
    vep_genome = 'GRCh38'
    vep_species = 'homo_sapiens'
    vep_cache_version = 111
    vep_out_format = 'tab'
    vep_params = '--no_stats --cache --offline --symbol --protein --canonical'
    publish_dir_mode = 'copy'
    email = null
    email_on_fail = null
    plaintext_email = false
    monochrome_logs = false
    help = false
    validate_params = true
    show_hidden_params = false
    version = false
    custom_config_version = 'master'
    max_cpus = 56
    schema_ignore_params = 'genomes'
    max_time = '240.h'
    max_memory = '512.GB'
    custom_config_base = 'https://raw.githubusercontent.com/nf-core/configs/master'
    filter_human = true
    duplex_high_conf = false
    filter_min_reads_high = '6 3 3'
    filter_min_baseq_high = 30
    filter_max_base_error_rate_high = '0.1 0.1 0.1'
    duplex_med_conf = true
    filter_min_reads_med = '4 2 2'
    filter_min_baseq_med = 30
    filter_max_base_error_rate_med = '0.1 0.1 0.1'
    duplex_low_conf = false
    filter_min_reads_low = '2 1 1'
    filter_min_baseq_low = 20
    filter_max_base_error_rate_low = '0.1 0.1 0.1'
    download_cache = false
    enable_conda = false
    config_profile_name = null
    config_profile_description = null
    config_profile_contact = null
    config_profile_url = null
}


process {
   withName:SAMPLESHEET_CHECK {
      publishDir = [path:{ "${params.outdir}/pipeline_info" }, mode:'copy', saveAs:{ filename -> filename.equals('versions.yml') ? null : filename }]
   }
   withName:'.*FASTQC' {
      ext {
         args = '--quiet'
      }
   }
   withName:FASTQTOBAM {
      publishDir = [enabled:false]
   }
   withName:FASTP {
      ext {
         args = '--disable_adapter_trimming'
      }
      publishDir = [enabled:false]
   }
   withName:'ALIGN.*BAM' {
      ext {
         bwa_args = { "-5 -L 1,1 -K 100000000" }
      }
      publishDir = [enabled:false]
   }
   withName:TRIMBAM {
      publishDir = [enabled:false]
   }
   withName:'SORTBAM.*' {
      ext {
         prefix = { ".sorted" }
         args = ' --write-index'
      }
   }
   withName:'SORTBAM|SORTBAMALLMOLECULES' {
      publishDir = [enabled:false]
   }
   withName:SORTBAMCLEAN {
      ext {
         prefix = { ".sorted" }
         args = ' --template-coordinate --write-index'
      }
      publishDir = [enabled:false]
   }
   withName:'SORTBAMAMFILTERED|SORTBAMMERGED' {
      ext {
         prefix = { ".sorted" }
         args = ' -n'
      }
   }
   withName:SORTBAMAMCLEAN {
      ext {
         prefix = {params.step in ['filterconsensus'] ?  ".new.sorted" :  ".sorted" }
      }
      publishDir = [enabled:false]
   }
   withName:'ASMINUSXS.*' {
      publishDir = [mode:'copy', path:{ "${params.outdir}/asxsdiscarded/" }, pattern:'*.discarded_AS-XS*.bam', enabled:false]
      ext {
         prefix = { ".filtered.AS-XS_${params.asminusxs_thres}" }
         threshold = '10'
      }
   }
   withName:'SAMTOOLSFILTER.*' {
      publishDir = [enabled:false]
      ext {
         prefix = { ".filtered.AS-XS_${params.asminusxs_thres}.0x2" }
         args = '-b -h --require-flags 0x2 --exclude-flags 0x900'
      }
   }
   withName:'DEEPUMICALLER:BAM_FILTER_READS:SORTBAMFIXED' {
      publishDir = [enabled:false]
   }
   withName:'DEEPUMICALLER:BAM_FILTER_READS:FGSELECTREADS' {
      ext {
         samtools_args = '-F 0x4 -F 0x8'
      }
      publishDir = [enabled:false]
   }
   withName:'DEEPUMICALLER:BAM_FILTER_READS:FILTERBAM' {
      ext {
         args = '--output-fmt bam                             --with-header'
         prefix = { ".region_filtered" }
      }
      publishDir = [enabled:false]
   }
   withName:'QUALIMAPQC.*' {
      ext {
         args = '--paint-chromosome-limits --genome-gc-distr HUMAN --skip-dup-mode 0 -outformat HTML'
      }
   }
   withName:QUALIMAPQCRAW {
      ext {
         prefix = { ".raw" }
      }
   }
   withName:QUALIMAPQCALLMOLECULES {
      ext {
         prefix = { ".all_molecules" }
      }
   }
   withName:QUALIMAPQCDUPLEX {
      ext {
         prefix = { ".duplex" }
      }
   }
   withName:'DISCARDEDCOVERAGE.*' {
      ext {
         args = '-mean'
      }
   }
   withName:COVERAGEGLOBAL {
      ext {
         args = '-mean'
      }
   }
   withName:GROUPREADSBYUMIDUPLEX {
      ext {
         args = '--edits 1                     --min-map-q 10'
      }
      publishDir = [enabled:false]
   }
   withName:CALLDUPLEXCONSENSUSREADS {
      ext {
         args = '--min-reads 1 1 0                     --min-input-base-quality 20                     --consensus-call-overlapping-bases true'
      }
      publishDir = [enabled:false]
   }
   withName:'COLLECTDUPLEXSEQMETRICS.*' {
      ext {
         args = '--duplex-umi-counts=true'
      }
   }
   withName:'CLIPBAM*' {
      ext {
         args = '--clipping-mode Hard                             --clip-overlapping-reads true                             --clip-bases-past-mate true                             --auto-clip-attributes true'
      }
      publishDir = [enabled:false]
   }
   withName:FILTERCONSENSUSREADSAM {
      ext {
         fgbio_args = ' --min-reads 2 1 0                                 --min-base-quality 20                                 --max-base-error-rate 0.1 0.1 0.1                                 --max-no-call-fraction 0.2                                 --require-single-strand-agreement false'
      }
      publishDir = [enabled:false]
   }
   withName:FILTERCONSENSUSREADSDUPLEX {
      ext {
         fgbio_args = ' --min-reads 4 2 2                                 --min-base-quality 30                                 --max-base-error-rate 0.1 0.1 0.1                                 --max-no-call-fraction 0.2                                 --require-single-strand-agreement true'
      }
      publishDir = [enabled:false]
   }
   withName:CREATEBED_FROM_TSV {
      ext {
         args = ' -d 20'
      }
   }
   withName:'CALLINGVARDICT.*' {
      ext {
         args = '-f 0.0 -r 1 -m 9999 -P 0 -p -z 1 -o 0.5 -L 100'
         filter_args = '-A -E -f 0.0 -p 10 -m 20 -v 1'
      }
   }
   withName:'.*ONTARGET' {
      ext {
         prefix = { ".on_target" }
      }
   }
   withName:'DEEPUMICALLER:VCFANNOTATE:.*:.*' {
      ext {
         prefix = { ".duplex" }
      }
   }
   withName:'DEEPUMICALLER:RECOUNTMUTS:.*' {
      ext {
         prefix = { ".duplex" }
      }
   }
   withName:'DEEPUMICALLER:RECOUNTMUTS.*:READJUSTREGIONS_AMP' {
      ext {
         amplify = 2
      }
   }
   withName:'DEEPUMICALLER:RECOUNTMUTS.*:PATCHDPALL' {
      ext {
         suffix = 'AM'
      }
   }
   withName:'DEEPUMICALLER:RECOUNTMUTS.*:PILEUPBAM.*' {
      ext {
         args = '--no-BAQ                             --max-depth 0                             --min-BQ 2                             --no-output-ends                             --output-extra QNAME'
      }
   }
   withName:'FILTERLOWCOMPLEX|FILTERLOWMAPPABLE|FILTERNANOSEQSNP|FILTERNANOSEQNOISE' {
      publishDir = [enabled:false]
   }
   withName:'PILEUPBAM.*|QUERYTABIX|BEDTOINTERVAL|READJUSTREGIONS|PATCH_DEPTH' {
      publishDir = [enabled:false]
   }
   withName:MUTSPERPOS {
      ext {
         args = '-l 270                                 --filter INCLUDE                                 -t 0                                 --clonality_limit 0.1                                 -c'
      }
      errorStrategy = 'ignore'
   }
   withName:FILTERNRICH {
      ext {
         filter_name = 'n_rich'
         minimum_depth = '25'
      }
      publishDir = [path:{ "${params.outdir}/mutations_vcf" }, mode:'copy', pattern:'*.filtered.vcf']
   }
   withName:FILTERVCFSOMATIC {
      ext {
         vaf_filter = '0.35'
         filters = 'no_pileup_support,low_complex_repetitive,low_mappability,n_rich'
         splitting = 'True'
      }
      publishDir = [enabled:false]
   }
   withName:FILTERVCFPLOT {
      ext {
         vaf_filter = '0.35'
         filters = 'no_pileup_support,low_complex_repetitive,low_mappability,n_rich,singletons_only'
      }
      publishDir = [enabled:false]
   }
   withName:'SIGPROFPLOT.*' {
      ext {
         prefix = 'test_FASTQs'
         args = '--plot                             --tsb_stat                             --seqInfo                             --cushion 100'
         genome_assembly = 'GRCh38'
      }
   }
}
